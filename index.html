<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¹´ã®ç›®æ¨™ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <style>
        :root {
            --bg-color: #fcfaf2;
            --text-color: #333;
            --accent-red: #c94444;
            --accent-blue: #446cc9;
            --accent-green: #2e8b57;
            --card-bg: #ffffff;
            --locked-bg: #e0e0e0;
        }

        body {
            font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
        h1 {
            text-align: center;
            border-bottom: 2px solid var(--accent-red);
            padding: 15px;
            margin: 0 0 20px 0;
            font-size: 1.5rem;
            letter-spacing: 0.1em;
        }

        button {
            font-family: "Hiragino Kaku Gothic ProN", sans-serif;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        button:hover { opacity: 0.9; }

        .screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .hidden { display: none !important; }

        /* --- ãƒ›ãƒ¼ãƒ ç”»é¢ --- */
        .setting-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            width: 100%;
            max-width: 400px;
        }

        .setting-item {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .setting-item label { font-weight: bold; font-size: 0.95rem; }
        .setting-item input {
            width: 60px;
            padding: 8px;
            font-size: 1rem;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #btn-start {
            background-color: var(--accent-red);
            color: white;
            padding: 15px 50px;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(201, 68, 68, 0.3);
        }

        /* --- ãƒ¡ã‚¤ãƒ³ç”»é¢ --- */
        .status-header {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #555;
            font-weight: bold;
            height: 1.5rem; /* é«˜ã•ç¢ºä¿ */
        }

        .grid-container {
            display: grid;
            gap: 10px;
            width: 100%;
            margin-bottom: 20px;
            /* åˆ—æ•°ã¯JSã§åˆ¶å¾¡ */
        }

        .kanji-card {
            aspect-ratio: 1;
            background-color: var(--card-bg);
            border: 1px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            user-select: none;
            opacity: 0; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨åˆæœŸçŠ¶æ…‹ */
            transform: scale(0.8);
            transition: transform 0.2s;
        }

        /* è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .kanji-card.show {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.5s ease-out, transform 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        .kanji-card:hover { transform: translateY(-2px); }
        
        .kanji-card.locked {
            background-color: var(--locked-bg);
            color: #999;
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1);
            cursor: default;
            transform: none !important;
        }
        .kanji-card.locked::after {
            content: 'æ¸ˆ';
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 0.7rem;
            color: #aaa;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: auto;
            padding-bottom: 20px;
        }
        
        .btn-ctrl {
            padding: 12px 20px;
            color: white;
            font-size: 0.95rem;
        }
        .btn-ctrl:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #ccc !important;
        }

        #btn-list { background-color: #555; }
        #btn-remain { background-color: var(--accent-blue); }
        #btn-reset { background-color: var(--accent-red); }

        /* --- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆä¸€è¦§ï¼‰ --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }

        .goal-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
            text-align: left;
        }

        .goal-item {
            margin-bottom: 15px;
            border-bottom: 1px dotted #ccc;
            padding-bottom: 5px;
        }
        .goal-title {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 5px;
        }
        .goal-chars {
            display: flex;
            gap: 8px;
        }
        .char-box {
            width: 45px;
            height: 45px;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            cursor: pointer;
            background: #fff;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .char-box:hover {
            background-color: #fee; /* å‰Šé™¤ç¤ºå”†è‰² */
            border-color: var(--accent-red);
        }
        .char-box.empty {
            border: 1px dashed #ccc;
            background: #f9f9f9;
            cursor: default;
            color: #ddd;
        }
        .char-box.empty:hover {
            background: #f9f9f9;
            border-color: #ccc;
        }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-ai-copy {
            background-color: var(--accent-green);
            color: white;
            padding: 12px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .modal-close {
            background-color: #333;
            color: white;
            padding: 10px 40px;
        }

        /* ã‚³ãƒ”ãƒ¼å®Œäº†ãƒˆãƒ¼ã‚¹ãƒˆ */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 200;
        }
        #toast.show { opacity: 1; }

        /* å®Œäº†ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        @keyframes flash {
            0% { background-color: rgba(255,255,255,0); }
            50% { background-color: rgba(255,215,0,0.3); }
            100% { background-color: rgba(255,255,255,0); }
        }
        .flash-effect {
            animation: flash 0.6s ease-out;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«èª¿æ•´ */
        @media (max-width: 480px) {
            .kanji-card { font-size: 1.6rem; }
            h1 { font-size: 1.3rem; }
        }

    </style>
</head>
<body>

    <div id="home-screen" class="screen">
        <h1>æ–°å¹´ã®ç›®æ¨™ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
        <p style="margin-bottom:30px; color:#666; text-align:center; font-size:0.9rem;">
            ç›´æ„Ÿã§æ¼¢å­—ã‚’é¸ã³<br>æ–°ã—ã„å¹´ã®ç›®æ¨™ã‚’ç´¡ãã¾ã—ã‚‡ã†
        </p>
        
        <div class="setting-group">
            <div class="setting-item">
                <label>ä½œæˆã™ã‚‹ç›®æ¨™ã®æ•°</label>
                <input type="number" id="inp-total-goals" value="5" min="1" max="100">
            </div>
            <div class="setting-item">
                <label>1ã¤ã®ç›®æ¨™ã®æ–‡å­—æ•°</label>
                <input type="number" id="inp-chars-per-goal" value="2" min="1" max="4">
            </div>
            <div class="setting-item">
                <label>ãƒœãƒ¼ãƒ‰ã«è¡¨ç¤ºã™ã‚‹æ¼¢å­—æ•°</label>
                <input type="number" id="inp-board-size" value="10" min="4" max="25">
            </div>
        </div>

        <button id="btn-start">å§‹ã‚ã‚‹</button>
    </div>

    <div id="main-screen" class="screen hidden">
        <h1>æ–°å¹´ã®ç›®æ¨™ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
        
        <div class="status-header" id="status-text">
            </div>

        <div class="grid-container" id="board-grid">
            </div>

        <div class="controls">
            <button id="btn-list" class="btn-ctrl">ç›®æ¨™ä¸€è¦§</button>
            <button id="btn-remain" class="btn-ctrl">æ®‹ãƒªã‚»ãƒƒãƒˆ</button>
            <button id="btn-reset" class="btn-ctrl">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div id="popup-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-top:0; font-size:1.2rem; border-bottom:1px solid #eee; padding-bottom:10px;">ã‚ãªãŸã®ç›®æ¨™ä¸€è¦§</h2>
            <p style="font-size:0.8rem; color:#666;">æ¼¢å­—ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨å–ã‚Šæ¶ˆã›ã¾ã™</p>
            <ul class="goal-list" id="goal-list-container">
                </ul>
            
            <div class="modal-actions">
                <button class="btn-ai-copy" onclick="copyPrompt()">
                    <span>ğŸ¤–</span> AIç›¸è«‡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
                </button>
                <button class="modal-close" onclick="closePopup()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="toast">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>

    <script>
        // ===============================================
        // 1. æ¼¢å­—ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
        // ===============================================
        const kanjiDataset = [
            // æ•°å€¤ãƒ»è¦æ¨¡
            "ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹","å",
            "ç™¾","åƒ","ä¸‡","å„„","å…†","é›¶","å€","åŠ","å…¨","ç„¡",
            // å…·ä½“ç‰©ãƒ»å¯¾è±¡
            "èŒ¶","çˆ","ç²","é…’","æ°´","ç±³","éºº","èœ","è‚‰","é­š",
            "ç”»","éŸ³","æ­Œ","æ—…","æœ¬","æ˜ ","æ¹¯","åº­","èŠ±","æœ¨",
            "é‡‘","å®","æ ª","ç¨","è·","æ¥­","å‹™","å®…","è²¨","è³‡",
            "æ­¯","é«ª","è‚Œ","ç­‹","éª¨","è…¹","è…°","è„³","çœ¼","æŒ‡",
            "æœ","é´","é„","é¡","éµ","è»Š","çª“","åºŠ","å£","æœº",
            "ç­†","è¨˜","å¸³","ç°¿","æš¦","çŠ¶","è¨¼","æ‹ ","æ¡ˆ","é¡",
            // å ´æ‰€ãƒ»è‡ªç„¶
            "å®¤","å¸­","æ‰‰","åº—","å¡¾","å±€","å³¶","æ¸¯","è¡—","é“",
            "ç•‘","æ£®","ç©º","é›²","é›¨","æ™´","é¢¨","é›ª","é›·","è™¹",
            "å¤©","åœ°","æ˜Ÿ","é™½","å…‰","é—‡",
            // æ™‚é–“ãƒ»æœŸé–“
            "æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ","æ—¥","æ›œ",
            "é€±","æœŸ","é–“","å¹´","å­£","æ˜¥","å¤","ç§‹","å†¬",
            "æœ","æ˜¼","å¤œ","ç¬","æš‡","æ˜”","ä»Š","æ¬¡","æ¯","ç¶š",
            // ä½ç½®ãƒ»é–¢ä¿‚ãƒ»è‰²
            "å†…","å¤–","å…¬","ç§","è¡¨","è£","ä¸Š","ä¸­","ä¸‹","ç«¯",
            "è‰²","å½©","ç™½","é»’","èµ¤","é’","é»„","ç·‘","ç´«","éŠ€",
            "è¦ª","å­","å‹","å¸«","å·±","èª°","è¡†","å®¢","å¦»","å¤«",
            // æ„Ÿè¦šãƒ»çŸ¥è¦š
            "è¦‹","è¦³","è¦–","è§¦","é¦™","å—…","å‘³","è´","æ„Ÿ",
            // å‹•ä½œãƒ»çŠ¶æ…‹
            "å—","è³","èª­","æ›¸","è¨€","å•","ç­”","è€ƒ","å­¦","ç¿’","ç©¶","çŸ¥",
            "é€š","èµ°","æ³³","ç™»","æŠ•","é£›","è·³","èˆ","è¸Š","æ­©",
            "æ‹“","å±•","æŒ‘","æˆ¦","å§‹","çµ‚","å¤‰","æ–°","æ”¹","å‰µ",
            "æ•´","ç†","æ´—","ç£¨","æ‹­","æƒ","æ¨","æ–­","ç¸«","ç·¨",
            "å¡—","æ","å£²","è²·","è²¸","å€Ÿ","è²¯","æ‰•","å¾—","æ",
            "ç¨¼","å‹Ÿ","å®ˆ","æ”»","å¾…","æ€¥","æ­¢","é€²","æˆ»","ç›´",
            "äº¤","æ··","ä¿¡","ç–‘","ç†±","å†·","ç”˜","è‹¦","è»½","é‡",
            "æ—©","é…","å¹¸","ç¦","ç¬‘","æ³£","æ€’","å–œ","æ¥½","è¬",
            "æ„›","æ‹","å¤¢","å¸Œ","æœ›","å¿—","èª ","å®Ÿ","è¨±","æ•‘","å°","è©«"
        ];

        // ===============================================
        // 2. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // ===============================================
        function numberToDaiji(num) {
            if (num === 100) return "ä½°";
            const digits = ["", "å£±", "å¼", "å‚", "è‚†", "ä¼", "é™¸", "æ¼†", "æŒ", "ç–"];
            if (num < 10) return digits[num];
            
            const tens = Math.floor(num / 10);
            const ones = num % 10;
            let result = "";
            if (tens === 1) result += "æ‹¾";
            else result += digits[tens] + "æ‹¾";
            
            if (ones > 0) result += digits[ones];
            return result;
        }

        // ===============================================
        // 3. çŠ¶æ…‹ç®¡ç†
        // ===============================================
        let settings = { totalGoals: 5, charsPerGoal: 2, boardSize: 10 };
        let selectedKanjiList = [];
        let currentBoard = []; 
        let isAnimating = false;

        // ===============================================
        // 4. åˆæœŸåŒ–ãƒ»ç”»é¢é·ç§»
        // ===============================================
        document.getElementById('btn-start').addEventListener('click', startGame);
        document.getElementById('btn-list').addEventListener('click', openPopup);
        document.getElementById('btn-remain').addEventListener('click', remainReset);
        document.getElementById('btn-reset').addEventListener('click', fullReset);

        function startGame() {
            const tg = parseInt(document.getElementById('inp-total-goals').value) || 5;
            const cpg = parseInt(document.getElementById('inp-chars-per-goal').value) || 2;
            let bs = parseInt(document.getElementById('inp-board-size').value) || 10;

            // å®‰å…¨è£…ç½®
            const requiredTotal = tg * cpg;
            if (bs < requiredTotal) {
                alert(`è¨­å®šã•ã‚ŒãŸç›®æ¨™ã‚’ä½œã‚‹ã«ã¯æœ€ä½ ${requiredTotal} å€‹ã®æ¼¢å­—æ ãŒå¿…è¦ã§ã™ã€‚\nãƒœãƒ¼ãƒ‰ã®è¡¨ç¤ºæ•°ã‚’ ${requiredTotal} å€‹ã«è‡ªå‹•èª¿æ•´ã—ã¦é–‹å§‹ã—ã¾ã™ã€‚`);
                bs = requiredTotal;
                document.getElementById('inp-board-size').value = bs;
            }

            settings = { totalGoals: tg, charsPerGoal: cpg, boardSize: bs };

            const grid = document.getElementById('board-grid');
            grid.className = 'grid-container';
            if(bs <= 4) grid.style.gridTemplateColumns = "repeat(2, 1fr)";
            else if(bs <= 9) grid.style.gridTemplateColumns = "repeat(3, 1fr)";
            else if(bs <= 16) grid.style.gridTemplateColumns = "repeat(4, 1fr)";
            else grid.style.gridTemplateColumns = "repeat(5, 1fr)";

            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');

            initGame();
        }

        function initGame() {
            selectedKanjiList = [];
            generateNewBoard(settings.boardSize);
            updateStatus();
        }

        // ===============================================
        // 5. ãƒœãƒ¼ãƒ‰ç”Ÿæˆãƒ»æç”»ãƒ­ã‚¸ãƒƒã‚¯
        // ===============================================
        
        function getRandomKanji(count, excludeList = []) {
            let candidates = kanjiDataset.filter(k => !excludeList.includes(k));
            if(candidates.length < count) candidates = [...kanjiDataset];
            
            const result = [];
            for(let i=0; i<count; i++){
                const idx = Math.floor(Math.random() * candidates.length);
                result.push(candidates[idx]);
                candidates.splice(idx, 1);
            }
            return result;
        }

        function generateNewBoard(count) {
            const chars = getRandomKanji(count);
            currentBoard = chars.map(c => ({ char: c, locked: false }));
            renderBoardWithAnimation();
        }

        function renderBoardWithAnimation() {
            const grid = document.getElementById('board-grid');
            grid.innerHTML = '';
            isAnimating = true;
            updateControlButtons();

            currentBoard.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'kanji-card';
                el.textContent = item.char;
                
                if(item.locked) {
                    el.classList.add('locked', 'show');
                } else {
                    el.addEventListener('click', () => onCardClick(index));
                }
                grid.appendChild(el);
            });

            const unlockedIndices = currentBoard
                .map((item, i) => item.locked ? -1 : i)
                .filter(i => i !== -1);
            
            if(unlockedIndices.length === 0) {
                isAnimating = false;
                updateControlButtons();
                return;
            }

            // â˜…å…¨ä½“ã§10ç§’ï¼ˆ10000msï¼‰ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´
            const TOTAL_DURATION = 10000;
            const interval = TOTAL_DURATION / unlockedIndices.length;

            unlockedIndices.forEach((idx, order) => {
                setTimeout(() => {
                    if(grid.children[idx]) {
                        grid.children[idx].classList.add('show');
                    }
                    if (order === unlockedIndices.length - 1) {
                        isAnimating = false;
                        updateControlButtons();
                    }
                }, order * interval);
            });
        }

        function renderBoardSimple() {
            const grid = document.getElementById('board-grid');
            Array.from(grid.children).forEach((card, index) => {
                const item = currentBoard[index];
                if(item.locked) card.classList.add('locked');
                else card.classList.remove('locked');
                card.textContent = item.char;
            });
        }

        function onCardClick(index) {
            if(isAnimating) return;
            const item = currentBoard[index];
            if(item.locked) return;

            const maxChars = settings.totalGoals * settings.charsPerGoal;
            if(selectedKanjiList.length >= maxChars) return;

            item.locked = true;
            selectedKanjiList.push(item.char);
            
            renderBoardSimple();
            updateStatus();
            checkCompletion();
        }

        function updateStatus() {
            const currentCount = selectedKanjiList.length;
            const total = settings.totalGoals * settings.charsPerGoal;
            
            if(currentCount >= total) {
                document.getElementById('status-text').textContent = "å…¨ã¦ã®ç›®æ¨™ãŒå®Œæˆã—ã¾ã—ãŸï¼";
                return;
            }

            const currentGoalIndex = Math.floor(currentCount / settings.charsPerGoal);
            const numText = numberToDaiji(currentGoalIndex + 1);
            const inGoalCount = (currentCount % settings.charsPerGoal) + 1;
            
            document.getElementById('status-text').textContent = 
                `${numText}ãƒç›®æ¨™ (${inGoalCount}/${settings.charsPerGoal}æ–‡å­—) ã‚’é¸æŠä¸­...`;
        }

        function checkCompletion() {
            const total = settings.totalGoals * settings.charsPerGoal;
            if(selectedKanjiList.length === total) {
                document.body.classList.add('flash-effect');
                setTimeout(() => document.body.classList.remove('flash-effect'), 600);
                setTimeout(() => openPopup(), 1000);
            }
        }

        function updateControlButtons() {
            const btns = document.querySelectorAll('.btn-ctrl');
            btns.forEach(b => b.disabled = isAnimating);
        }

        // ===============================================
        // 6. ãƒªã‚»ãƒƒãƒˆ & ä¸€è¦§æ©Ÿèƒ½
        // ===============================================

        function remainReset() {
            if(isAnimating) return;
            const exclude = [...currentBoard.filter(i => i.locked).map(i => i.char), ...selectedKanjiList];
            
            const unlockedIndices = currentBoard.map((item, i) => item.locked ? -1 : i).filter(i => i !== -1);
            if(unlockedIndices.length === 0) return;

            const newChars = getRandomKanji(unlockedIndices.length, exclude);
            let newCharIdx = 0;
            currentBoard.forEach(item => {
                if(!item.locked) {
                    item.char = newChars[newCharIdx++];
                }
            });

            renderBoardWithAnimation();
        }

        function fullReset() {
            if(isAnimating) return;
            if(!confirm("ç¾åœ¨ã®é€²æ—ã‚’å…¨ã¦ç ´æ£„ã—ã¦ã€æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")) return;
            initGame();
        }

        function openPopup() {
            const listContainer = document.getElementById('goal-list-container');
            listContainer.innerHTML = '';

            for(let i=0; i<settings.totalGoals; i++) {
                const li = document.createElement('li');
                li.className = 'goal-item';

                const title = document.createElement('div');
                title.className = 'goal-title';
                const numText = numberToDaiji(i + 1);
                title.textContent = `${numText}ãƒç›®æ¨™`;
                li.appendChild(title);

                const charContainer = document.createElement('div');
                charContainer.className = 'goal-chars';

                for(let j=0; j<settings.charsPerGoal; j++) {
                    const globalIndex = i * settings.charsPerGoal + j;
                    const char = selectedKanjiList[globalIndex];
                    
                    const box = document.createElement('div');
                    box.className = 'char-box';
                    
                    if(char) {
                        box.textContent = char;
                        box.onclick = () => undoSelection(globalIndex, char);
                        box.title = "ã‚¿ãƒƒãƒ—ã—ã¦å–ã‚Šæ¶ˆã—";
                    } else {
                        box.className += ' empty';
                        box.textContent = 'ï¼Ÿ';
                    }
                    charContainer.appendChild(box);
                }
                li.appendChild(charContainer);
                listContainer.appendChild(li);
            }

            document.getElementById('popup-overlay').classList.add('active');
        }

        function closePopup() {
            document.getElementById('popup-overlay').classList.remove('active');
        }

        function undoSelection(listIndex, charToRemove) {
            selectedKanjiList.splice(listIndex, 1);
            for (let item of currentBoard) {
                if(item.char === charToRemove && item.locked) {
                    item.locked = false;
                    break;
                }
            }
            openPopup();
            renderBoardSimple();
            updateStatus();
        }

        document.getElementById('popup-overlay').addEventListener('click', (e) => {
            if(e.target.id === 'popup-overlay') closePopup();
        });

        // ===============================================
        // 7. AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ & ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ (ä¿®æ­£ç‰ˆ)
        // ===============================================
        function copyPrompt() {
            let promptText = "ç§ã¯ã€Œæ¼¢å­—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«çµ„ã¿åˆã‚ã›ã¦æ–°å¹´ã®ç›®æ¨™ã‚’ä½œã‚‹ã€ã¨ã„ã†ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—ã‚’è¡Œã„ã¾ã—ãŸã€‚\n";
            promptText += "ãã“ã§é¸ã‚“ã ä»¥ä¸‹ã®ã€Œæ¼¢å­—ã®çµ„ã¿åˆã‚ã›ã€ã‚’ãƒ†ãƒ¼ãƒã«ã—ã¦ã€å…·ä½“çš„ã§å‰å‘ããªã€Œæ–°å¹´ã®ç›®æ¨™ï¼ˆå®£è¨€æ–‡ï¼‰ã€ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è€ƒãˆã¦ãã ã•ã„ã€‚\n\n";
            promptText += "â– ä¾é ¼äº‹é …\n";
            
            // â˜…è¿½åŠ æ¡ä»¶ï¼šãƒœãƒªãƒ¥ãƒ¼ãƒ åˆ¶å¾¡
            if (settings.totalGoals > 10) {
                promptText += "ãƒ»ç›®æ¨™æ•°ãŒå¤šã„ãŸã‚ã€1ã¤ã®çµ„ã¿åˆã‚ã›ã«ã¤ãã€Œè‡ªä¿¡ã®ã‚ã‚‹1æ¡ˆã®ã¿ã€ã‚’å‡ºã—ã¦ãã ã•ã„ã€‚\n";
            } else {
                promptText += "ãƒ»ãã‚Œãã‚Œã®çµ„ã¿åˆã‚ã›ã«ã¤ãã€è§£é‡ˆã®ç•°ãªã‚‹æ¡ˆã‚’3ãƒ‘ã‚¿ãƒ¼ãƒ³å‡ºã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šãƒ“ã‚¸ãƒã‚¹ç›®æ¨™ã€è‡ªå·±å•“ç™ºç›®æ¨™ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªç›®æ¨™ãªã©ï¼‰ã€‚\n";
            }

            // â˜…è¿½åŠ æ¡ä»¶ï¼šå¿…é ˆä½¿ç”¨ãƒ»é †ä¸åŒ
            promptText += "ãƒ»ä½œæˆã•ã‚Œã‚‹ç›®æ¨™æ–‡ã®ä¸­ã«ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦ãã®æ¼¢å­—ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚\n";
            promptText += "ãƒ»æ¼¢å­—ã®ä¸¦ã³é †ã¯é †ä¸åŒã§æ§‹ã„ã¾ã›ã‚“ã€‚èª­ã¿æ–¹ã‚„é€ã‚Šä»®åã‚‚æ–‡è„ˆã«åˆã‚ã›ã¦è‡ªç”±ã«å¤‰ãˆã¦OKã§ã™ã€‚\n";
            promptText += "ãƒ»ã€Œãªãœãã®è§£é‡ˆã«ãªã£ãŸã‹ã€ã®çŸ­ã„è£œè¶³ã‚‚æ·»ãˆã¦ãã ã•ã„ã€‚\n\n";

            promptText += "â– ç§ã®é¸ã‚“ã æ¼¢å­—ãƒªã‚¹ãƒˆ\n";

            let hasContent = false;

            for(let i = 0; i < settings.totalGoals; i++) {
                const startIndex = i * settings.charsPerGoal;
                const slice = selectedKanjiList.slice(startIndex, startIndex + settings.charsPerGoal);
                
                const label = `${numberToDaiji(i+1)}ãƒç›®æ¨™`;
                let contentStr = "";

                if(slice.length > 0) {
                    contentStr = `[ ${slice.join(' ] [ ')} ]`;
                    hasContent = true;
                } else {
                    contentStr = "(æœªé¸æŠ)";
                }
                
                promptText += `${label}ï¼š${contentStr}\n`;
            }

            if(!hasContent) {
                alert("ç›®æ¨™ãŒã¾ã ä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }

            promptText += "\nã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚";

            if (navigator.clipboard) {
                navigator.clipboard.writeText(promptText).then(() => {
                    showToast();
                }).catch(err => {
                    fallbackCopyTextToClipboard(promptText);
                });
            } else {
                fallbackCopyTextToClipboard(promptText);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                var successful = document.execCommand('copy');
                if(successful) showToast();
                else alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert("ãŠä½¿ã„ã®ç’°å¢ƒã§ã¯ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚");
            }
            document.body.removeChild(textArea);
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

    </script>
</body>
</html>
